


function E = foraging_2AFC_setup(W)
    
    
    %% set parameters
    
    nTrialsByCond = 10;
    nBlocksByCond = 2;
    
    fixationColor = [ 0,0,0 ];
    fixationSizeDeg = 0.4;
    fixationThicknessDeg = 0.1;
    fixationTextDistDeg = 8;
    
    stimWidthDeg = 10;
    stimMean = linspace(0,1,5);
    stimConcentration = exp([-7,-4]);
    stimSpeedChange = 10;
    stimScale = 1/2;
    stimFrames = 3;
    
    durFixSec = 0.5;
    durGapSec = 0.2;
    durStimSec = [0.1,0.2,0.4,0.8];
    durItiSec = 0.0;
    durPauseSec = 5;
    
    textSize = 32;
    textStyle = 0;
    textFont = 'Arial';
    textColor = 255;
    textFreqHz = 1;
    
    
    %% convert units
    
    fixationSizeRad = fixationSizeDeg*pi/180;
    fixationThicknessRad = fixationThicknessDeg*pi/180;
    fixationTextDistRad = fixationTextDistDeg*pi/180;
    stimWidthRad = stimWidthDeg*pi/180;
    
    fixationSizeCm = W.viewingDistCm*tan(fixationSizeRad);
    fixationThicknessCm = W.viewingDistCm*tan(fixationThicknessRad);
    fixationTextDistCm = W.viewingDistCm*tan(fixationTextDistRad);
    stimWidthCm = W.viewingDistCm*tan(stimWidthRad);
    
    fixationSizePix = fixationSizeCm/W.pixSize;
    fixationThicknessPix = fixationThicknessCm/W.pixSize;
    fixationTextDistPix = fixationTextDistCm/W.pixSize;
    stimWidthPix = round(stimWidthCm/W.pixSize);
    
    
    %% set up design
    
    nCond = 3*length(durStimSec)*length(stimMean)*length(stimConcentration);
    nTrials = nTrialsByCond*nCond;
    nBlocks = nBlocksByCond*3*length(durStimSec);
    
    blockList = repmat(1:3*length(durStimSec)*nBlocksByCond,nTrials/(3*length(durStimSec)*nBlocksByCond),1);
    blockList = blockList(:);
    
    [blockCond,blockDur] = meshgrid(1:3,durStimSec,1:nBlocksByCond);
    randBlock = randperm(3*length(durStimSec)*nBlocksByCond);
    
    blockCond = blockCond(randBlock);
    blockDur = blockDur(randBlock);
    
    condList = repmat(blockCond,nTrials/(3*length(durStimSec)*nBlocksByCond),1);
    condList = condList(:);
    
    durList = repmat(blockDur,nTrials/(3*length(durStimSec)*nBlocksByCond),1);
    durList = durList(:);
    
    randVec = NaN(nTrials/(3*length(durStimSec)),(3*length(durStimSec)));
    meanList = NaN(nTrials,1);
	concentrationList = NaN(nTrials,1);
    for cc=1:3
        for dd=1:length(durStimSec)
            [meanTmp,concentrationTmp] = meshgrid(stimMean,stimConcentration,1:nTrialsByCond);
            randVec(:,(cc-1)*length(durStimSec)+dd) = randperm(nTrials/(3*length(durStimSec)));
            meanList((condList==cc)&(durList==durStimSec(dd))) = meanTmp(randVec(:,cc));
            concentrationList((condList==cc)&(durList==durStimSec(dd))) = concentrationTmp(randVec(:,cc));
        end
    end
    
    
    %% generate structure
    
    E = struct(...
        'nTrials',                      nTrials , ...
        'nBlocks',                      nBlocks , ...
        'nBlocksByCond',              	nBlocksByCond , ...
        'nTrialsByCond',                nTrialsByCond , ...
        'fixationColor',                fixationColor , ...
        'fixationSizeDeg',              fixationSizeDeg , ...
        'fixationThicknessDeg',         fixationThicknessDeg , ...
        'fixationTextDistDeg',          fixationTextDistDeg , ...
        'fixationSizeRad',              fixationSizeRad , ...
        'fixationThicknessRad',         fixationThicknessRad , ...
        'fixationTextDistRad',          fixationTextDistRad , ...
        'fixationSizeCm',               fixationSizeCm , ...
        'fixationThicknessCm',          fixationThicknessCm , ...
        'fixationTextDistCm',           fixationTextDistCm' , ...
        'fixationSizePix',              fixationSizePix , ...
        'fixationThicknessPix',         fixationThicknessPix , ...
        'fixationTextDistPix',        	fixationTextDistPix , ...
        'stimWidthDeg',                 stimWidthDeg , ...
        'stimWidthRad',                 stimWidthRad , ...
        'stimWidthCm',                  stimWidthCm , ...
        'stimWidthPix',                 stimWidthPix , ...
        'stimMean',                     stimMean , ...
        'stimConcentration',            stimConcentration , ...
        'stimSpeedChange',              stimSpeedChange , ...
        'stimScale',                    stimScale , ...
        'stimFrames',                   stimFrames , ...
        'durFixSec',                    durFixSec , ...
        'durGapSec',                    durGapSec , ...
        'durStimSec',                   durStimSec , ...
        'durItiSec',                    durItiSec , ...
        'durPauseSec',                  durPauseSec , ...
        'blockList',                    blockList , ...
        'randVec',                      randVec , ...
        'condList',                     condList , ...
        'durList',                      durList , ...
        'meanList',                     meanList , ...
        'concentrationList',            concentrationList , ...
        'textSize',                     textSize , ...
        'textStyle',                    textStyle , ...
        'textFont',                     textFont , ...
        'textColor',                    textColor , ...
        'textFreqHz',                   textFreqHz ...
        );
    
    
end


